<!doctype html>
<html lang="ms">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jadual Penjagaan (Live)</title>

  <!-- Mermaid -->
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>

  <!-- Schedule -->
  <script src="./schedule.js"></script>

  <style>
    body {
      font-family: -apple-system, system-ui, Segoe UI, Roboto, Arial, sans-serif;
      margin: 16px;
      line-height: 1.4;
      background: #fafafa;
    }
    .card {
      background: white;
      border: 1px solid #ddd;
      border-radius: 14px;
      padding: 14px;
      margin-bottom: 14px;
    }
    .title { font-size: 20px; font-weight: 800; }
    .sub { color: #555; margin-top: 4px; }
    .on { font-size: 22px; font-weight: 900; margin-top: 6px; }

    .pill {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid #ddd;
      font-size: 12px;
      margin-left: 6px;
    }
    .ok { background: #e9f7ef; border-color: #bfe6cf; }
    .warn { background: #fff6d6; border-color: #f2d17d; }
    .bad { background: #fdecec; border-color: #f5b5b5; }

    .muted { color: #666; font-size: 13px; }
    .small { font-size: 12px; color: #777; }
    .highlight { font-weight: 900; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 6px;
    }
    th, td {
      padding: 8px;
      border-bottom: 1px solid #eee;
      text-align: left;
    }
    th {
      font-size: 12px;
      text-transform: uppercase;
      color: #666;
    }

    .history-item {
      border-top: 1px dashed #ddd;
      padding-top: 8px;
      margin-top: 8px;
    }
    .history-time {
      font-size: 12px;
      color: #666;
    }
    .history-text {
      margin-top: 4px;
      font-weight: 600;
      white-space: pre-wrap;
    }
  </style>
</head>

<body>

<!-- HEADER -->
<div class="card">
  <div class="title" id="pageTitle">Jadual Penjagaan Mak (Live)</div>
  <div class="sub">
    Masa rujukan: <b>Asia/Kuala_Lumpur</b>
    <span class="pill" id="statusPill">â€”</span>
  </div>
</div>

<!-- ON DUTY -->
<div class="card">
  <div class="muted">ðŸ”´ Sedang bertugas sekarang</div>
  <div class="on" id="onDutyText">Memuatkanâ€¦</div>
  <div class="small" id="onDutyWindow"></div>
  <div class="small" id="backupText"></div>
</div>

<!-- UMI STATUS -->
<div class="card">
  <div class="muted">ðŸ©º Kemas Kini Keadaan Umi</div>
  <div id="umiStatusText" class="highlight" style="margin-top:6px;">
    Memuatkanâ€¦
  </div>
  <div class="small" id="umiStatusTime"></div>

  <div id="umiHistoryWrap" style="margin-top:10px;"></div>
</div>

<!-- JADUAL TABLE -->
<div class="card">
  <div class="muted">ðŸ“‹ Jadual Penjagaan</div>
  <div id="tableWrap"></div>
</div>

<!-- MERMAID -->
<div class="card">
  <div class="muted">ðŸ“Š Timeline</div>
  <div class="mermaid" id="mermaidGantt">Loadingâ€¦</div>
</div>

<script>
/* =====================================================
   UTILITIES
===================================================== */
function minutesAgo(iso) {
  const diff = Date.now() - new Date(iso).getTime();
  const mins = Math.floor(diff / 60000);
  if (mins < 1) return "baru sahaja";
  if (mins < 60) return mins + " minit lalu";
  const hrs = Math.floor(mins / 60);
  const rem = mins % 60;
  if (hrs < 24) return hrs + " jam " + rem + "m lalu";
  return Math.floor(hrs / 24) + " hari lalu";
}

function fmt(dt) {
  return new Intl.DateTimeFormat("ms-MY", {
    dateStyle: "short",
    timeStyle: "short",
    hour12: false,
    timeZone: "Asia/Kuala_Lumpur"
  }).format(new Date(dt));
}

/* =====================================================
   SCHEDULE
===================================================== */
function renderSchedule() {
  const tz = "Asia/Kuala_Lumpur";
  const now = new Date();

  const statusPill = document.getElementById("statusPill");
  const onDutyText = document.getElementById("onDutyText");
  const onDutyWindow = document.getElementById("onDutyWindow");
  const backupText = document.getElementById("backupText");

  const slot = SCHEDULE.slots.find(
    s => now >= new Date(s.start) && now < new Date(s.end)
  );

  if (!slot) {
    statusPill.className = "pill warn";
    statusPill.innerText = "Tiada slot";
    onDutyText.innerText = "Tiada penjaga dikesan sekarang";
  } else {
    statusPill.className = "pill ok";
    statusPill.innerText = "Sedang berjalan";
    onDutyText.innerText = "ðŸ”´ " + slot.person + " â€” " + slot.label;
  }

  onDutyWindow.innerText =
    "Window: " + fmt(SCHEDULE.windowStart) + " â†’ " + fmt(SCHEDULE.windowEnd);
  backupText.innerText = "Backup: " + (SCHEDULE.backup || "-");

  // Table
  document.getElementById("tableWrap").innerHTML = `
    <table>
      <thead>
        <tr><th>Masa</th><th>Penjaga</th><th>Slot</th></tr>
      </thead>
      <tbody>
        ${SCHEDULE.slots.map(s => `
          <tr>
            <td>${fmt(s.start)} â†’ ${fmt(s.end)}</td>
            <td>${s.person}</td>
            <td>${s.label}</td>
          </tr>
        `).join("")}
      </tbody>
    </table>
  `;

  // Mermaid
  const gantt = `
gantt
  title Jadual Penjagaan Mak
  dateFormat YYYY-MM-DD HH:mm
  axisFormat %d/%m %H:%M

  section Shift
  ${SCHEDULE.slots.map((s,i)=>`${s.person} (${s.label}) : t${i}, ${s.start.replace("T"," ")}, ${s.end.replace("T"," ")}`).join("\n  ")}
  `;
  const el = document.getElementById("mermaidGantt");
  el.textContent = gantt;
  mermaid.initialize({ startOnLoad: false });
  mermaid.run({ querySelector: "#mermaidGantt" });
}

/* =====================================================
   UMI STATUS FROM GITHUB JSON
===================================================== */
const UMI_JSON_URL = "./umi-status.json";

async function renderUmi() {
  try {
    const res = await fetch(UMI_JSON_URL + "?t=" + Date.now());
    const data = await res.json();

    document.getElementById("umiStatusText").innerText = data.latest.text;
    document.getElementById("umiStatusTime").innerText =
      "Dikemas kini " + minutesAgo(data.latest.updatedAt);

    document.getElementById("umiHistoryWrap").innerHTML = `
      <div class="muted">ðŸ“œ History update</div>
      ${data.history.map(h => `
        <div class="history-item">
          <div class="history-time">${fmt(h.updatedAt)} â€¢ ${minutesAgo(h.updatedAt)}</div>
          <div class="history-text">${h.text}</div>
        </div>
      `).join("")}
    `;
  } catch (e) {
    document.getElementById("umiStatusText").innerText =
      "Gagal load status umi.";
  }
}

/* =====================================================
   INIT
===================================================== */
renderSchedule();
renderUmi();
setInterval(renderSchedule, 30000);
setInterval(renderUmi, 60000);
</script>

</body>
</html>